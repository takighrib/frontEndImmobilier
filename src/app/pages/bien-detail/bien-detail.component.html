<div class="bien-detail-page">

  <!-- ── Loading ──────────────────────────────────── -->
  <div *ngIf="loading" class="loading">
    <div class="spinner"></div>
    <p>Chargement...</p>
  </div>

  <!-- ── Error ────────────────────────────────────── -->
  <div *ngIf="error" class="error-container">
    <i class="fas fa-exclamation-triangle"></i>
    <h2>{{ error }}</h2>
    <a routerLink="/biens" class="btn btn-primary">Retour aux biens</a>
  </div>

  <!-- ── Bien Detail ───────────────────────────────── -->
  <div *ngIf="!loading && !error && bien" class="container">

    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <a routerLink="/">Accueil</a>
      <i class="fas fa-chevron-right"></i>
      <a routerLink="/biens">Biens</a>
      <i class="fas fa-chevron-right"></i>
      <span>{{ bien.titre }}</span>
    </div>

    <!-- Main Content -->
    <div class="detail-content">

      <!-- ── Colonne gauche : Galerie + Description ── -->
      <div class="gallery-column">

        <!-- Gallery -->
        <div class="gallery-section">
          <div class="main-image">

            <!-- Image cliquable → Lightbox -->
            <img
              [src]="bien.images[currentImageIndex].urlImage"
              [alt]="bien.titre"
              (click)="openLightbox(currentImageIndex)"
              style="cursor: zoom-in; width: 100%; height: 100%; object-fit: cover; display: block;">

            <!-- Badge type transaction -->
            <span class="bien-badge" [class.badge-location]="bien.typeTransaction === 'LOCATION'">
              {{ bien.typeTransaction === 'VENTE' ? 'À Vendre' : 'À Louer' }}
            </span>

            <!-- Icône zoom au survol -->
            <div class="zoom-hint" (click)="openLightbox(currentImageIndex)">
              <i class="fas fa-expand-alt"></i>
            </div>

            <!-- Compteur images -->
            <div class="image-counter" *ngIf="bien.images.length > 1">
              <i class="fas fa-images"></i>
              {{ currentImageIndex + 1 }} / {{ bien.images.length }}
            </div>

            <!-- Flèches navigation -->
            <button
              class="arrow arrow-left"
              (click)="prevImage()"
              *ngIf="bien.images.length > 1"
              aria-label="Image précédente">
              <i class="fas fa-chevron-left"></i>
            </button>
            <button
              class="arrow arrow-right"
              (click)="nextImage()"
              *ngIf="bien.images.length > 1"
              aria-label="Image suivante">
              <i class="fas fa-chevron-right"></i>
            </button>

          </div>

          <!-- Thumbnails -->
          <div class="thumbnails" *ngIf="bien.images.length > 1">
            <div
              *ngFor="let image of bien.images; let i = index"
              class="thumbnail"
              [class.active]="i === currentImageIndex"
              (click)="selectImage(i)"
              [attr.aria-label]="'Sélectionner image ' + (i + 1)">
              <img [src]="image.urlImage" [alt]="'Aperçu ' + (i + 1)">
            </div>
          </div>
        </div>

        <!-- ── Description Professionnelle ────────── -->
        <div class="description-section">

          <!-- Header -->
          <div class="desc-header">
            <div class="desc-title-group">
              <div class="desc-icon">
                <i class="fas fa-file-alt"></i>
              </div>
              <div>
                <h2>Description du bien</h2>
                <p class="desc-subtitle">Informations détaillées fournies par l'agence</p>
              </div>
            </div>
            <!-- Badge référence -->
            <div class="desc-ref">
              <span class="ref-label">Référence</span>
              <span class="ref-value">#{{ bien.id }}</span>
            </div>
          </div>

          <!-- Séparateur décoratif -->
          <div class="desc-divider">
            <span class="divider-line"></span>
            <span class="divider-dot"><i class="fas fa-home"></i></span>
            <span class="divider-line"></span>
          </div>

          <!-- Corps texte avec expand/collapse -->
          <div class="desc-body" [class.expanded]="descriptionExpanded">
            <p>{{ bien.description }}</p>
            <div class="desc-fade" *ngIf="!descriptionExpanded"></div>
          </div>

          <!-- Bouton Voir plus / Voir moins -->
          <button
            class="btn-toggle-desc"
            (click)="toggleDescription()"
            *ngIf="bien.description && bien.description.length > 300">
            <span>{{ descriptionExpanded ? 'Voir moins' : 'Voir plus' }}</span>
            <i class="fas"
              [class.fa-chevron-down]="!descriptionExpanded"
              [class.fa-chevron-up]="descriptionExpanded"></i>
          </button>

          <!-- Footer méta-infos -->
          <div class="desc-footer">
            <div class="desc-meta-item">
              <i class="fas fa-building"></i>
              <span>Hajri Immo — Agence immobilière</span>
            </div>
            <div class="desc-meta-item">
              <i class="fas fa-map-marker-alt"></i>
              <span>{{ bien.ville }}, Tunisie</span>
            </div>
            <div class="desc-meta-item">
              <i class="fas fa-tag"></i>
              <span>{{ bien.typeTransaction === 'VENTE' ? 'Vente' : 'Location' }} · {{ bien.typeBien }}</span>
            </div>
          </div>

        </div>
        <!-- Fin Description -->

      </div>

      <!-- ── Colonne droite : Info + Contact ──────── -->
      <div class="info-section">
        <h1>{{ bien.titre }}</h1>

        <div class="location">
          <i class="fas fa-map-marker-alt"></i>
          <span>{{ bien.adresse }}, {{ bien.ville }}</span>
        </div>

        <!-- Prix -->
        <div class="prix-container">
          <div class="prix">
            {{ bienService.formatPrix(bien.prix) }}
            <span class="prix-unite">
              {{ bien.typeTransaction === 'LOCATION' ? 'DT/mois' : 'DT' }}
            </span>
          </div>
        </div>

        <!-- Caractéristiques -->
        <div class="caracteristiques-grid">
          <div class="carac-item">
            <i class="fas fa-ruler-combined"></i>
            <div class="carac-info">
              <div class="label">Surface</div>
              <div class="value">{{ bien.surface }} m²</div>
            </div>
          </div>
          <div class="carac-item" *ngIf="bien.nombreChambres">
            <i class="fas fa-bed"></i>
            <div class="carac-info">
              <div class="label">Chambres</div>
              <div class="value">{{ bien.nombreChambres }}</div>
            </div>
          </div>
          <div class="carac-item" *ngIf="bien.nombreSallesBain">
            <i class="fas fa-bath"></i>
            <div class="carac-info">
              <div class="label">Salles de bain</div>
              <div class="value">{{ bien.nombreSallesBain }}</div>
            </div>
          </div>
          <div class="carac-item" *ngIf="bien.nombrePieces">
            <i class="fas fa-home"></i>
            <div class="carac-info">
              <div class="label">Pièces</div>
              <div class="value">{{ bien.nombrePieces }}</div>
            </div>
          </div>
        </div>

        <!-- Équipements -->
        <div class="equipements"
          *ngIf="bien.jardin || bien.garage || bien.piscine || bien.climatisation || bien.parking || bien.balcon || bien.meuble">
          <h3>Équipements</h3>
          <div class="equipements-grid">
            <div class="equipement" *ngIf="bien.jardin">
              <i class="fas fa-tree"></i><span>Jardin</span>
            </div>
            <div class="equipement" *ngIf="bien.garage">
              <i class="fas fa-warehouse"></i><span>Garage</span>
            </div>
            <div class="equipement" *ngIf="bien.piscine">
              <i class="fas fa-swimming-pool"></i><span>Piscine</span>
            </div>
            <div class="equipement" *ngIf="bien.climatisation">
              <i class="fas fa-snowflake"></i><span>Climatisation</span>
            </div>
            <div class="equipement" *ngIf="bien.parking">
              <i class="fas fa-parking"></i><span>Parking</span>
            </div>
            <div class="equipement" *ngIf="bien.balcon">
              <i class="fas fa-building"></i><span>Balcon</span>
            </div>
            <div class="equipement" *ngIf="bien.meuble">
              <i class="fas fa-couch"></i><span>Meublé</span>
            </div>
          </div>
        </div>

        <!-- Boutons Contact -->
        <div class="contact-buttons">
          <a href="tel:+21670123456" class="btn btn-primary">
            <i class="fas fa-phone"></i>
            <span>Appeler</span>
          </a>
          <a [href]="getWhatsAppLink()" class="btn btn-whatsapp" target="_blank" rel="noopener">
            <i class="fab fa-whatsapp"></i>
            <span>WhatsApp</span>
          </a>
          <a routerLink="/contact" [queryParams]="{bienId: bien.id}" class="btn btn-outline">
            <i class="fas fa-envelope"></i>
            <span>Email</span>
          </a>
        </div>

      </div>
    </div>
  </div>

  <!-- ══════════════════════════════════════════════ -->
  <!--   LIGHTBOX MODAL                              -->
  <!-- ══════════════════════════════════════════════ -->
  <div
    class="lightbox-overlay"
    *ngIf="lightboxOpen && bien"
    (click)="closeLightbox()"
    role="dialog"
    aria-modal="true"
    aria-label="Visionneuse d'images">

    <!-- Bouton fermer -->
    <button class="lightbox-close" (click)="closeLightbox()" aria-label="Fermer">
      <i class="fas fa-times"></i>
    </button>

    <!-- Flèche gauche -->
    <button
      class="lightbox-arrow lightbox-prev"
      (click)="$event.stopPropagation(); lightboxPrev()"
      *ngIf="bien.images.length > 1"
      aria-label="Image précédente">
      <i class="fas fa-chevron-left"></i>
    </button>

    <!-- Image centrale -->
    <div class="lightbox-content" (click)="$event.stopPropagation()">
      <img
        [src]="bien.images[lightboxIndex].urlImage"
        [alt]="bien.titre + ' — image ' + (lightboxIndex + 1)">
      <div class="lightbox-counter">
        <i class="fas fa-images"></i>
        {{ lightboxIndex + 1 }} / {{ bien.images.length }}
      </div>
    </div>

    <!-- Flèche droite -->
    <button
      class="lightbox-arrow lightbox-next"
      (click)="$event.stopPropagation(); lightboxNext()"
      *ngIf="bien.images.length > 1"
      aria-label="Image suivante">
      <i class="fas fa-chevron-right"></i>
    </button>

    <!-- Miniatures lightbox -->
    <div
      class="lightbox-thumbnails"
      *ngIf="bien.images.length > 1"
      (click)="$event.stopPropagation()">
      <div
        *ngFor="let image of bien.images; let i = index"
        class="lightbox-thumb"
        [class.active]="i === lightboxIndex"
        (click)="lightboxIndex = i">
        <img [src]="image.urlImage" [alt]="'Miniature ' + (i + 1)">
      </div>
    </div>

  </div>

</div>